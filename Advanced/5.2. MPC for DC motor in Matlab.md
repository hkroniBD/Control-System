
# Lecture: MATLAB Implementation of MPC for DC Motor Control

## 1. Introduction
- **Objective**: Demonstrate how to implement an MPC controller in MATLAB to control the angular velocity of a DC motor, respecting constraints on input voltage.
- **Prerequisites**:
  - MATLAB with Control System Toolbox and MPC Toolbox installed.
  - Basic understanding of MPC concepts, state-space models, and MATLAB/Simulink.
- **Example System**: A DC motor where the input is the armature voltage (\(u\)) and the output is the angular velocity (\(\omega\)).
- **Goal**: Track a desired angular velocity setpoint (e.g., step changes between 50 rad/s and 100 rad/s) while respecting voltage constraints.

## 2. DC Motor Model
- **System Description**:
  - A DC motor can be modeled as a second-order system with states: angular velocity (\(\omega\)) and armature current (\(i\)).
  - Input: Armature voltage (\(u\), in volts).
  - Output: Angular velocity (\(\omega\), in rad/s).
- **State-Space Model** (continuous-time):
  \[
  \dot{x}(t) = Ax(t) + Bu(t), \quad y(t) = Cx(t)
  \]
  where \(x = [\omega, i]^T\), and typical parameters are:
  - \(J = 0.01 \, \text{kg·m}^2\): Moment of inertia.
  - \(b = 0.1 \, \text{N·m·s}\): Damping coefficient.
  - \(K = 0.01 \, \text{N·m/A}\): Torque constant.
  - \(R = 1 \, \Omega\): Armature resistance.
  - \(L = 0.5 \, \text{H}\): Armature inductance.
  - State-space matrices:
    \[
    A = \begin{bmatrix} -\frac{b}{J} & \frac{K}{J} \\ -\frac{K}{L} & -\frac{R}{L} \end{bmatrix} = \begin{bmatrix} -10 & 1 \\ -0.02 & -2 \end{bmatrix}, \quad
    B = \begin{bmatrix} 0 \\ \frac{1}{L} \end{bmatrix} = \begin{bmatrix} 0 \\ 2 \end{bmatrix}, \quad
    C = \begin{bmatrix} 1 & 0 \end{bmatrix}, \quad D = 0
    \]
- **Constraints**:
  - Input: \(-24 \leq u \leq 24 \, \text{V}\) (typical for a DC motor).
  - Output: \(\omega \geq 0 \, \text{rad/s}\).
- **Sampling Time**: \(T_s = 0.1 \, \text{s}\) (suitable for motor dynamics).
- **Objective**: Track a reference angular velocity while minimizing control effort and respecting voltage limits.

## 3. MATLAB Implementation Steps
Below is a step-by-step guide to implementing MPC for the DC motor in MATLAB, with a complete script.

### Step 1: Define the Plant Model
- Create and discretize the state-space model.
```matlab
% Define DC motor parameters
J = 0.01; % Moment of inertia (kg·m^2)
b = 0.1;  % Damping coefficient (N·m·s)
K = 0.01; % Torque constant (N·m/A)
R = 1;    % Armature resistance (Ohm)
L = 0.5;  % Armature inductance (H)

% State-space matrices
A = [-b/J, K/J; -K/L, -R/L];
B = [0; 1/L];
C = [1, 0];
D = 0;

% Create continuous-time state-space model
plant = ss(A, B, C, D);

% Discretize the model
Ts = 0.1; % Sampling time (s)
plant = c2d(plant, Ts);
```

### Step 2: Create the MPC Controller
- Define the MPC controller with prediction and control horizons, and weights.
```matlab
% MPC parameters
Np = 20; % Prediction horizon
Nc = 5;  % Control horizon
mpcobj = mpc(plant, Ts);

% Set MPC properties
mpcobj.PredictionHorizon = Np;
mpcobj.ControlHorizon = Nc;

% Define weights
mpcobj.Weights.OutputVariables = 1; % Weight on tracking error
mpcobj.Weights.ManipulatedVariables = 0.05; % Weight on control effort
```

### Step 3: Specify Constraints
- Add constraints on input voltage and output velocity.
```matlab
% Input constraints (voltage: -24 to 24 V)
mpcobj.MV.Min = -24;
mpcobj.MV.Max = 24;

% Output constraints (velocity >= 0 rad/s)
mpcobj.OV.Min = 0;
```

### Step 4: Simulate the Closed-Loop System
- Simulate the MPC controller tracking a reference trajectory.
```matlab
% Simulation settings
T_sim = 10; % Simulation time (s)
N_sim = T_sim/Ts;
r = [50*ones(N_sim/2,1); 100*ones(N_sim/2,1)]; % Reference: 50 rad/s for 0–5s, 100 rad/s for 5–10s
x0 = [0; 0]; % Initial state [velocity; current]

% Initialize variables
y = zeros(N_sim+1, 1); % Output (angular velocity)
u = zeros(N_sim, 1); % Input (voltage)
x = x0;

% Simulation loop
for k = 1:N_sim
    y(k) = C * x; % Measure output
    u(k) = mpcmove(mpcobj, x, y(k), r(k)); % Compute control action
    x = plant.A * x + plant.B * u(k); % Update state
end
y(N_sim+1) = C * x; % Final output
```

### Step 5: Plot Results
- Visualize the angular velocity and voltage trajectories.
```matlab
% Plot results
t = 0:Ts:T_sim;
figure;
subplot(2,1,1);
plot(t, y, 'b', t, r, 'r--');
xlabel('Time (s)');
ylabel('Angular Velocity (rad/s)');
title('DC Motor Angular Velocity');
legend('Actual', 'Reference');
grid on;

subplot(2,1,2);
plot(t(1:end-1), u, 'b');
xlabel('Time (s)');
ylabel('Voltage (V)');
title('Control Input');
grid on;
```

## 4. Simulink Implementation
Simulink provides a visual way to simulate the DC motor MPC system.

### Step 1: Create the Simulink Model
1. Open Simulink: `simulink`.
2. Add Blocks:
   - **State-Space Block**: For the discrete-time DC motor model.
   - **MPC Controller Block**: From MPC Toolbox.
   - **Step Block**: For the reference signal (50 rad/s for 0–5s, 100 rad/s for 5–10s).
   - **Scope Block**: To visualize outputs.
   - **Mux Block**: To combine signals for the Scope.

### Step 2: Configure Blocks
- **State-Space Block**:
  - Set matrices \(A\), \(B\), \(C\), \(D\) from the discretized model.
  - Sample time: 0.1 s.
- **MPC Controller Block**:
  - Export `mpcobj` to the workspace (from MATLAB script).
  - Set “MPC Controller” parameter to `mpcobj`.
- **Step Block**:
  - Step time: 5 s.
  - Initial value: 50 rad/s, Final value: 100 rad/s.
  - Sample time: 0.1 s.
- **Connections**:
  - Step output to MPC Controller’s reference input.
  - State-Space output to MPC Controller’s measured output.
  - MPC Controller output to State-Space input.
  - Mux reference and output to Scope.

### Step 3: Simulate
- Set simulation time to 10 s.
- Run and view results in the Scope.

## 5. Tuning the MPC Controller
Tuning is critical for balancing tracking performance and control effort.

### Tuning Example
- Compare two values of the control effort weight (\(R\)).
```matlab
% Tuning example: Compare R weights
R_values = [0.05, 0.5];
y_all = zeros(N_sim+1, length(R_values));
u_all = zeros(N_sim, length(R_values));

for j = 1:length(R_values)
    mpcobj = mpc(plant, Ts);
    mpcobj.PredictionHorizon = 20;
    mpcobj.ControlHorizon = 5;
    mpcobj.Weights.OutputVariables = 1;
    mpcobj.Weights.ManipulatedVariables = R_values(j);
    mpcobj.MV.Min = -24; mpcobj.MV.Max = 24; mpcobj.OV.Min = 0;
    
    x = x0; y = zeros(N_sim+1, 1); u = zeros(N_sim, 1);
    for k = 1:N_sim
        y(k) = C * x;
        u(k) = mpcmove(mpcobj, x, y(k), r(k));
        x = plant.A * x + plant.B * u(k);
    end
    y(N_sim+1) = C * x;
    y_all(:,j) = y; u_all(:,j) = u;
end

% Plot results
figure;
subplot(2,1,1);
plot(t, y_all(:,1), 'b', t, y_all(:,2), 'g', t, r, 'r--');
xlabel('Time (s)'); ylabel('Angular Velocity (rad/s)');
title('Velocity with Different R Weights');
legend('R=0.05', 'R=0.5', 'Reference'); grid on;

subplot(2,1,2);
plot(t(1:end-1), u_all(:,1), 'b', t(1:end-1), u_all(:,2), 'g');
xlabel('Time (s)'); ylabel('Voltage (V)');
title('Control Input with Different R Weights');
legend('R=0.05', 'R=0.5'); grid on;
```

### Tuning Guidelines
- **Prediction Horizon (\(N_p\))**: Use 20–30 for smooth tracking of motor dynamics.
- **Control Horizon (\(N_c\))**: Set to 3–5 to reduce computation.
- **Weights**:
  - Increase \(Q\) (OutputVariables) for faster tracking.
  - Increase \(R\) (ManipulatedVariables) for smoother voltage.
- **Interactive Tuning**:
  ```matlab
  mpcDesigner(mpcobj)
  ```
  - Use the GUI to adjust parameters and visualize responses.

## 6. Practical Considerations
- **Model Accuracy**: The DC motor model assumes linear dynamics. For nonlinear effects (e.g., saturation), use `nlmpc`.
- **Disturbances**: Add a disturbance model (e.g., load torque) using `mpcobj.Model.Disturbance`.
- **Real-Time Implementation**: Ensure optimization solves within 0.1 s (use fast QP solvers or reduce \(N_c\)).
- **State Estimation**: Use a Kalman filter (`setEstimator`) for unmeasured states (e.g., current).

## 7. Complete MATLAB Script
```matlab
% File: mpc_dc_motor.m
% Description: MPC for DC motor angular velocity control
% Author: [Your Name]
% Date: August 29, 2025

clear all; close all;

% Step 1: Define DC motor model
J = 0.01; b = 0.1; K = 0.01; R = 1; L = 0.5;
A = [-b/J, K/J; -K/L, -R/L];
B = [0; 1/L];
C = [1, 0];
D = 0;
plant = ss(A, B, C, D);
Ts = 0.1; % Sampling time (s)
plant = c2d(plant, Ts);

% Step 2: Create MPC controller
Np = 20; Nc = 5;
mpcobj = mpc(plant, Ts);
mpcobj.PredictionHorizon = Np;
mpcobj.ControlHorizon = Nc;
mpcobj.Weights.OutputVariables = 1;
mpcobj.Weights.ManipulatedVariables = 0.05;
mpcobj.MV.Min = -24; mpcobj.MV.Max = 24;
mpcobj.OV.Min = 0;

% Step 3: Simulate
T_sim = 10; N_sim = T_sim/Ts;
r = [50*ones(N_sim/2,1); 100*ones(N_sim/2,1)];
x0 = [0; 0];
y = zeros(N_sim+1, 1); u = zeros(N_sim, 1); x = x0;

for k = 1:N_sim
    y(k) = C * x;
    u(k) = mpcmove(mpcobj, x, y(k), r(k));
    x = plant.A * x + plant.B * u(k);
end
y(N_sim+1) = C * x;

% Step 4: Plot results
t = 0:Ts:T_sim;
figure;
subplot(2,1,1);
plot(t, y, 'b', t, r, 'r--');
xlabel('Time (s)'); ylabel('Angular Velocity (rad/s)');
title('DC Motor Angular Velocity'); legend('Actual', 'Reference'); grid on;

subplot(2,1,2);
plot(t(1:end-1), u, 'b');
xlabel('Time (s)'); ylabel('Voltage (V)');
title('Control Input'); grid on;
```

## 8. Conclusion
- This lecture demonstrated MPC implementation for a DC motor using MATLAB and Simulink.
- The example showed how to control angular velocity while respecting voltage constraints.
- Tuning and Simulink provide practical tools for optimizing and visualizing performance.
- Extend to real-world applications (e.g., robotics, automotive) by adding disturbances or nonlinearities.

## 9. Further Exploration
- **Exercises**:
  - Add a load torque disturbance and test robustness.
  - Implement a nonlinear MPC controller using `nlmpc`.
  - Use `mpcDesigner` to tune parameters interactively.
- **Resources**:
  - MATLAB MPC Toolbox Documentation (`doc mpc`).
  - MathWorks example: `mpc_dcservo`.
  - Book: “Model Predictive Control System Design and Implementation Using MATLAB” by Liuping Wang.

---

## Notes
- **Script Sharing**: Save the script as `mpc_dc_motor.m` for distribution. Copy-paste the code above or share via GitHub.
- **Simulink Model**: Create and save as `dc_motor_mpc.slx`. Request if you need a detailed `.slx` file description.
- **Enhancements**: If you want a deeper dive (e.g., nonlinear MPC, real-time code generation, or slides), please specify.
- **Clarification**: If you meant something else by “complete the response” or need a specific focus (e.g., different motor model, additional features), let me know!
